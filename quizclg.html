<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Career Quiz | CareerDisha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        .quiz-card { transition: all 0.3s ease; }
        .quiz-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .quiz-card.selected { border-color: #3b82f6; background-color: #eff6ff; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .progress-bar { transition: width 0.5s ease; }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 bg-gray-50">
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="./index.html" class="flex-shrink-0 flex items-center">
                        <i data-feather="compass" class="text-blue-600 h-8 w-8"></i>
                        <span class="ml-2 text-xl font-bold text-blue-600">CareerDisha</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="progress-container" class="mb-8">
            <div class="flex justify-between mb-2">
                <span class="text-sm font-medium text-blue-600">Progress</span>
                <span class="text-sm font-medium text-gray-600"><span id="current-question-display">1</span>/<span id="total-questions-display">7</span></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="quiz-progress" class="progress-bar bg-blue-600 h-2.5 rounded-full" style="width: 14.28%"></div>
            </div>
        </div>

        <div id="quiz-container" class="bg-white rounded-xl shadow-md overflow-hidden p-6 md:p-8">
            <!-- Questions will be injected here by JavaScript -->
        </div>

        <div id="navigation-buttons" class="mt-8 flex justify-between">
            <button id="prev-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition duration-300 hidden items-center"><i data-feather="arrow-left" class="inline-block mr-2 h-4 w-4"></i>Back</button>
            <button id="next-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 ml-auto flex items-center">Next<i data-feather="arrow-right" class="inline-block ml-2 h-4 w-4"></i></button>
        </div>

        <div id="loading-container" class="hidden text-center py-8">
             <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h2 class="mt-4 text-xl font-semibold text-gray-800">Analyzing your results...</h2>
            <p class="text-gray-600">Our AI is crafting your personalized career roadmap.</p>
        </div>

    </div>

    <script>
    // --- quiz data (unchanged) ---
  const quizData = [
  {
    id: 1,
    question: "Which degree program are you currently pursuing?",
    subtext: "Select one.",
    type: "single",
    options: [
      "Engineering",
      "Medical/Allied Health",
      "Commerce/Management",
      "Arts/Humanities",
      "Science (BSc)",
      "Other"
    ]
  },
  {
    id: 2,
    question: "What is your main career goal after graduation?",
    subtext: "Select one.",
    type: "single",
    options: [
      "Get a job immediately",
      "Go for higher studies (Masters/PhD/UPSC/Exams)",
      "Start my own business/entrepreneurship",
      "Not sure yet"
    ]
  },
  {
    id: 3,
    question: "Which skills do you most want to develop during college?",
    subtext: "Select up to 3.",
    type: "multiple",
    options: [
      "Communication & Public Speaking",
      "Leadership & Management",
      "Technical/Coding",
      "Research & Analytics",
      "Creative/Design Thinking",
      "Networking & Collaboration"
    ],
    maxSelections: 3
  },
  {
    id: 4,
    question: "What motivates you the most in your career choice?",
    subtext: "Select one.",
    type: "single",
    options: [
      "High salary and stability",
      "Passion & interest",
      "Prestige & recognition",
      "Social impact / helping others"
    ]
  },
  {
    id: 5,
    question: "Are you planning to pursue higher studies in India or abroad?",
    subtext: "Select one.",
    type: "single",
    options: [
      "India",
      "Abroad",
      "Not sure yet"
    ]
  },
  {
    id: 6,
    question: "Which type of workplace excites you most?",
    subtext: "Select one.",
    type: "single",
    options: [
      "Corporate/Office environment",
      "Startups/Entrepreneurial culture",
      "Hospitals/Clinics",
      "Research labs",
      "Creative studios/media"
    ]
  },
  {
    id: 7,
    question: "Do you want to prepare for competitive exams?",
    subtext: "Select one.",
    type: "single",
    options: [
      "Yes, Indian exams (UPSC, SSC, Banking, etc.)",
      "Yes, International exams (GRE, GMAT, IELTS, etc.)",
      "No, I prefer direct jobs/other paths"
    ]
  },
  {
    id: 8,
    question: "How confident are you about your career direction right now?",
    subtext: "Select one.",
    type: "single",
    options: [
      "Very confident",
      "Somewhat confident",
      "Not confident at all"
    ]
  },
  {
    id: 9,
    question: "Would you like to start your own business in the future?",
    subtext: "Select one.",
    type: "single",
    options: [
      "Yes, immediately after college",
      "Yes, but later in life",
      "No, I prefer stable jobs"
    ]
  },
  {
    id: 10,
    question: "Which challenges do you face the most as a student?",
    subtext: "Select all that apply.",
    type: "multiple",
    options: [
      "Time management",
      "Financial stress",
      "Lack of guidance/mentorship",
      "Difficulty in studies",
      "Balancing personal & academic life"
    ]
  }
];


    // --- state / DOM refs ---
    let currentQuestionIndex = 0;
    const userAnswers = {};
    const urlParams = new URLSearchParams(window.location.search);
    const phase = urlParams.get("phase");

    // --- Prefill & skip first question based on study-level (URL param OR saved localStorage value) ---
    const levelParam = urlParams.get('level') || localStorage.getItem('careerDishaStudentLevel');
    // mapping must match the exact option strings in quizData[0].options
    const levelToOption = {
      'class10': 'Class 10',
      '11-12': 'Class 12',
      'college': 'College (UG)'
    };
    
    let skipFirstQuestion = false; // if true we will not show Q1 in UI (but still save its answer)
    if (levelParam && quizData && quizData.length > 0) {
      const mapped = levelToOption[levelParam];
      if (mapped) {
        // Pre-answer Q1 so API gets the value
        userAnswers[quizData[0].id] = [mapped];
    
        // Skip the first question UI so user doesn't see it again
        skipFirstQuestion = true;
    
        // Start the quiz at the second question (index 1)
        currentQuestionIndex = 1;
      }
    }
    


    const quizContainer = document.getElementById('quiz-container');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');

    // --- rendering ---
   function renderQuestion() {
    const questionData = quizData[currentQuestionIndex];

    // ✅ New: handle text-answer questions (no options)
    if (!questionData.options || questionData.options.length === 0) {
        quizContainer.innerHTML = `
            <h2 class="text-2xl font-bold text-gray-900 mb-2">${questionData.question}</h2>
            <p class="text-gray-600 mb-8">${questionData.subtext || ""}</p>
            <input 
              type="text" 
              id="free-answer" 
              placeholder="Enter your answer here..." 
              class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
        `;
        return; // stop here, no options to render
    }

    // existing rendering for options
    let optionsHtml = '';
    questionData.options.forEach(option => {
        const isSelected = userAnswers[questionData.id] && userAnswers[questionData.id].includes(option);
        optionsHtml += `
            <div class="quiz-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer ${isSelected ? 'selected' : ''}" data-value="${option}">
                <h3 class="font-medium text-gray-800">${option}</h3>
            </div>
        `;
    });

    quizContainer.innerHTML = `
        <h2 class="text-2xl font-bold text-gray-900 mb-2">${questionData.question}</h2>
        <p class="text-gray-600 mb-8">${questionData.subtext}</p>
        <div class="grid grid-cols-1 ${questionData.options.length > 4 ? 'sm:grid-cols-2' : ''} gap-4">
            ${optionsHtml}
        </div>
    `;
        document.querySelectorAll('.quiz-card').forEach(card => {
            card.addEventListener('click', () => handleOptionSelect(card, questionData));
        });

        updateNavigation();
        feather.replace();
    }

    function handleOptionSelect(card, questionData) {
        const value = card.dataset.value;
        if (!userAnswers[questionData.id]) {
            userAnswers[questionData.id] = [];
        }

        if (questionData.type === 'single') {
            userAnswers[questionData.id] = [value];
            document.querySelectorAll('.quiz-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
        } else if (questionData.type === 'multiple') {
            const selectedValues = userAnswers[questionData.id];
            if (selectedValues.includes(value)) {
                userAnswers[questionData.id] = selectedValues.filter(v => v !== value);
                card.classList.remove('selected');
            } else {
                if (!questionData.maxSelections || selectedValues.length < questionData.maxSelections) {
                    userAnswers[questionData.id].push(value);
                    card.classList.add('selected');
                }
            }
        }
    }

    function updateNavigation() {
        // If we skipped Q1, show counts relative to the visible questions
        const displayTotal = skipFirstQuestion ? (quizData.length - 1) : quizData.length;
        // If skipping Q1 we start at index 1, but for user-visible numbering we want "1" when currentQuestionIndex === 1
        const displayCurrent = skipFirstQuestion ? (currentQuestionIndex - 0) : (currentQuestionIndex + 1);
    
        document.getElementById('current-question-display').textContent = displayCurrent;
        document.getElementById('total-questions-display').textContent = displayTotal;
        document.getElementById('quiz-progress').style.width = ((displayCurrent) / displayTotal) * 100 + '%';
    
        // hide Prev if we're at the start (if Q1 skipped, start index is 1)
        prevBtn.classList.toggle('hidden', currentQuestionIndex === (skipFirstQuestion ? 1 : 0));
    
        nextBtn.innerHTML = currentQuestionIndex === quizData.length - 1
            ? 'Finish & See Results <i data-feather="award" class="inline-block ml-2 h-4 w-4"></i>'
            : 'Next <i data-feather="arrow-right" class="inline-block ml-2 h-4 w-4"></i>';
    }
    

    nextBtn.addEventListener('click', () => {
    const questionData = quizData[currentQuestionIndex];

    // ✅ Handle free-text questions
    if (!questionData.options || questionData.options.length === 0) {
        const input = document.getElementById('free-answer');
        const value = input.value.trim();
        if (!value) {
            alert("Please enter an answer before continuing.");
            return;
        }
        userAnswers[questionData.id] = [value];
    }
    // ✅ Handle option-based questions
    else if (!userAnswers[questionData.id] || userAnswers[questionData.id].length === 0) {
        alert("Please select an option to continue.");
        return;
    }

    if (currentQuestionIndex < quizData.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    } else {
        finishQuiz();
    }
});


    prevBtn.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            renderQuestion();
        }
    });

    // --- main finishQuiz with both Phase 1 & Phase 2 logic ---
    async function finishQuiz() {
    // Hide quiz UI, show loading spinner
    quizContainer.classList.add('hidden');
    document.getElementById('navigation-buttons').classList.add('hidden');
    document.getElementById('loading-container').classList.remove('hidden');

    try {
        const GEMINI_API_KEY = "AIzaSyA6U2sLH6A5o21dvSuqjDxPVq086UtukAE";
        const SUPABASE_URL = "https://mnarcdqecoxdidnjakch.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uYXJjZHFlY294ZGlkbmpha2NoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MTg2NzgsImV4cCI6MjA3MzA5NDY3OH0.INsDlgDxsrQiWPdZfRIXcI3EWLqD7dvWkaq3klaQyuc";

        if (phase !== "final") {
            // ================= Phase 1: Generate Follow-up Questions =================
            const prompt = `
You are a career coach for an undergraduate college student in India.

⚠️ Rules:
- Generate EXACTLY 10 follow-up questions.
- All must be multiple-choice (no text-only).
- Each must have 3–5 options.
- Each must include "type": "single" or "multiple".

Answers so far:
${JSON.stringify(userAnswers, null, 2)}

Return ONLY JSON in this format:
{
  "extraQuestions": [
    { "id": 101, "question": "Sample Q?", "type": "single", "options": ["A","B","C"] }
  ]
}
`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7, maxOutputTokens: 800, response_mime_type: "application/json" }
                })
            });

            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            let parsedPhase1;
            try {
                const jsonString = generatedText.substring(generatedText.indexOf('{'), generatedText.lastIndexOf('}') + 1);
                parsedPhase1 = JSON.parse(jsonString);
            } catch (e) { console.error("Failed to parse Gemini output (phase1):", e); parsedPhase1 = { extraQuestions: [] }; }
            
            let extraQs = parsedPhase1.extraQuestions || [];

// ✅ Step 1: filter out invalid/text-only
extraQs = extraQs.filter(q => Array.isArray(q.options) && q.options.length > 0);

// ✅ Step 2: pad until exactly 10
while (extraQs.length < 10) {
  extraQs.push({
    id: 300 + extraQs.length,
    question: `Backup Question ${extraQs.length + 1}`,
    type: "single",
    options: ["Option A", "Option B", "Option C", "Option D"]
  });
}

// ✅ Step 3: trim if more than 10
extraQs = extraQs.slice(0, 10);

            localStorage.setItem("careerDishaExtraQuestions", JSON.stringify(extraQs));
            localStorage.setItem("careerDishaQuizAnswers", JSON.stringify(userAnswers));
            
            window.location.href = "./questions.html?from=quizclg"; // Corrected redirect

        } else {
            // ================= Phase 2: Final Analysis =================
            const quizAnswers = JSON.parse(localStorage.getItem("careerDishaQuizAnswers") || "{}");
            const extraAnswers = JSON.parse(localStorage.getItem("careerDishaExtraAnswers") || "{}");
            const combinedAnswers = { quizAnswers, extraAnswers };

             const prompt = `
    You are a career coach for an undergraduate college student in India. The current date is September 18, 2025.
    Based on the student's answers, generate a personalized career roadmap.

    ***
    **Student's Answers:**
    ${JSON.stringify(combinedAnswers, null, 2)}
    ***

    Your task is to return ONLY a JSON object with five keys: "roadmapSummary", "keySkills", "careerWeb", and "recommendedResources".

    1.  **roadmapSummary**: A summary (~150 words) focusing on actionable advice.
    2.  **keySkills**: An array of exactly 4 essential skill objects. Each object MUST have "skill", "description", and an "icon" from this list: ['code', 'bar-chart', 'users', 'edit', 'speaker', 'database'].
    3.  **careerWeb**: An object representing 3 career progression paths. Each path must be an array of step objects, where each step object has a "step" and "description".
    4.  **keyTimeline**: An array of exactly 4 upcoming event objects. Each object MUST have a "title" (the name of the event), a "date" (Month YYYY), and a "type" from this list: ['internship', 'exam', 'placement', 'event'].
    5.  **recommendedResources**: An array of exactly 3 helpful resource objects. Each object MUST have a "title" (the name of the resource), a "description" (a brief summary), and a "url".

    Example of the required JSON output format:
    {
      "roadmapSummary": "...",
      "keySkills": [
        { "skill": "Data Analysis", "description": "Analyzing data to find insights.", "icon": "bar-chart" }
      ],
      "careerWeb": { "Corporate Path": [{ "step": "Internship", "description": "Gain experience." }] },
      "keyTimeline": [
        { "title": "CAT 2025 Registration Deadline", "date": "October 2025", "type": "exam" }
      ],
      "recommendedResources": [
        { "title": "Coursera", "description": "Online courses for professional development.", "url": "https://coursera.org" }
      ]
    }
`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7, maxOutputTokens: 2048, response_mime_type: "application/json" }
                })
            });

            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            let parsedPhase2;
            try {
                const jsonString = generatedText.substring(generatedText.indexOf('{'), generatedText.lastIndexOf('}') + 1);
                parsedPhase2 = JSON.parse(jsonString);
            } catch (e) { console.error("Failed to parse Gemini output (phase2):", e); parsedPhase2 = {}; }

            const finalResults = {
                roadmapSummary: parsedPhase2.roadmapSummary,
                keySkills: parsedPhase2.keySkills || [],

                careerWeb: parsedPhase2.careerWeb,
                keyTimeline: parsedPhase2.keyTimeline || [],
                recommendedResources: parsedPhase2.recommendedResources || []
            };
            console.log("Final data to be saved:", JSON.stringify(finalResults, null, 2)); 

// Check for essential data
if (!finalResults.roadmapSummary || !finalResults.keySkills || finalResults.keySkills.length === 0) {
    console.error("Validation failed: AI response is missing critical data.", finalResults);
    alert("Sorry, we couldn't generate a complete roadmap. Please try retaking the quiz.");
    // Stop execution and show the quiz again instead of redirecting
    document.getElementById('loading-container').classList.add('hidden');
    quizContainer.classList.remove('hidden');
    document.getElementById('navigation-buttons').classList.remove('hidden');
    return; // Stop here
}

            localStorage.setItem("careerDishaResults", JSON.stringify(finalResults));
            window.location.href = "./dashboardclg.html"; // Corrected redirect
        }
    } catch (err) {
        console.error("Error during analysis:", err);
        alert("An error occurred during the analysis. Please check your internet connection and try again.");
        // Unhide UI on error
        document.getElementById('loading-container').classList.add('hidden');
        document.getElementById('progress-container').classList.remove('hidden');
        quizContainer.classList.remove('hidden');
        document.getElementById('navigation-buttons').classList.remove('hidden');
    }
}
    // Initial load - render quiz or run final phase
    if (phase !== "final") {
        renderQuestion();
    } else {
    // FIX: Hide progress bar on final analysis page
    document.getElementById('progress-container').classList.add('hidden');
    quizContainer.classList.add('hidden');
    document.getElementById('navigation-buttons').classList.add('hidden');
    document.getElementById('loading-container').classList.remove('hidden');
    finishQuiz();
}
    </script>
</body>
</html>
