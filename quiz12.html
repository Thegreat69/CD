<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Career Quiz | CareerDisha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        .quiz-card { transition: all 0.3s ease; }
        .quiz-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .quiz-card.selected { border-color: #3b82f6; background-color: #eff6ff; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .progress-bar { transition: width 0.5s ease; }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 bg-gray-50">
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="./index.html" class="flex-shrink-0 flex items-center">
                        <i data-feather="compass" class="text-blue-600 h-8 w-8"></i>
                        <span class="ml-2 text-xl font-bold text-blue-600">CareerDisha</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="progress-container" class="mb-8">
            <div class="flex justify-between mb-2">
                <span class="text-sm font-medium text-blue-600">Progress</span>
                <span class="text-sm font-medium text-gray-600"><span id="current-question-display">1</span>/<span id="total-questions-display">7</span></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="quiz-progress" class="progress-bar bg-blue-600 h-2.5 rounded-full" style="width: 14.28%"></div>
            </div>
        </div>

        <div id="quiz-container" class="bg-white rounded-xl shadow-md overflow-hidden p-6 md:p-8">
            <!-- Questions will be injected here by JavaScript -->
        </div>

        <div id="navigation-buttons" class="mt-8 flex justify-between">
            <button id="prev-btn" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition duration-300 hidden items-center"><i data-feather="arrow-left" class="inline-block mr-2 h-4 w-4"></i>Back</button>
            <button id="next-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-300 ml-auto flex items-center">Next<i data-feather="arrow-right" class="inline-block ml-2 h-4 w-4"></i></button>
        </div>

        <div id="loading-container" class="hidden text-center py-8">
             <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <h2 class="mt-4 text-xl font-semibold text-gray-800">Analyzing your results...</h2>
            <p class="text-gray-600">Our AI is crafting your personalized career roadmap.</p>
        </div>

    </div>

    <script>
    // --- quiz data (unchanged) ---
    const quizData = [
    {
        id: 1,
        question: "Which subjects or topics do you enjoy the most in your current stream?",
        subtext: "Select all that apply.",
        type: "multiple",
        options: [
        "Mathematics & Logical Problem Solving",
        "Physics & Chemistry",
        "Biology & Life Sciences",
        "Economics / Business Studies / Accounts",
        "History / Political Science / Sociology",
        "Languages / Literature / Philosophy",
        "Creative fields (Arts, Design, Media, Performing Arts)",
        "Technology (Coding, AI, IT, Engineering basics)"
        ]
    },
    {
        id: 2,
        question: "Which entrance or competitive exams are you focusing on?",
        subtext: "Select all that apply.",
        type: "multiple",
        options: [
        "Engineering (JEE Main/Advanced, State CETs)",
        "Medical (NEET, AIIMS, etc.)",
        "Commerce/Management (CA, CS, CMA, CUET-Business)",
        "Law / Civil Services (CLAT, UPSC foundation, etc.)",
        "Design/Creative (NIFT, NID, UCEED, etc.)",
        "Other entrance tests (CUET, State exams, etc.)",
        "Not preparing for any exam yet"
        ]
    },
    {
        id: 3,
        question: "What do you see yourself doing after Class 12?",
        subtext: "Select one.",
        type: "single",
        options: [
        "Pursuing Engineering / Technology",
        "Becoming a Doctor / Healthcare professional",
        "Going into Business / Finance / Management",
        "Studying Arts / Humanities / Social Sciences",
        "Preparing for Law / Civil Services / Government roles",
        "Building a career in Creative fields (Design, Media, Arts)",
        "Not sure yet, still exploring"
        ]
    },
    {
        id: 4,
        question: "What motivates you the most when choosing a career?",
        subtext: "Select one.",
        type: "single",
        options: [
        "High salary & financial stability",
        "Prestige, recognition & respect",
        "Passion & personal interest",
        "Helping others / creating social impact",
        "Work–life balance & job security"
        ]
    },
    {
        id: 5,
        question: "Where would you prefer to study after Class 12?",
        subtext: "Select one.",
        type: "single",
        options: [
        "Nearby / local colleges",
        "Top institutions anywhere in India",
        "Abroad (international universities)",
        "Not decided yet"
        ]
    },
    {
        id: 6,
        question: "How long are you willing to continue your education?",
        subtext: "Select one.",
        type: "single",
        options: [
        "Short-term (1–3 years, diploma/degree)",
        "Medium-term (4–5 years, professional degrees like Engineering, MBBS, Law)",
        "Long-term (7+ years, specialization / PhD / advanced research)",
        "Not sure yet"
        ]
    },
    {
        id: 7,
        question: "Have you started planning your career path already?",
        subtext: "Select one.",
        type: "single",
        options: [
        "Yes, I have a clear plan",
        "I have some ideas but still exploring",
        "Not yet, I’m looking for proper guidance"
        ]
    },
    {
        id: 8,
        question: "Which skills do you feel you are strongest in?",
        subtext: "Select all that apply.",
        type: "multiple",
        options: [
        "Analytical & Logical Thinking",
        "Practical / Hands-on Skills",
        "Communication & Public Speaking",
        "Creativity & Innovation",
        "Leadership & Teamwork",
        "Research & Writing",
        "Problem-solving under pressure"
        ]
    },
    {
        id: 9,
        question: "Which broad career sector excites you the most?",
        subtext: "Select one.",
        type: "single",
        options: [
        "Technology & Engineering",
        "Medical & Healthcare",
        "Business, Finance & Management",
        "Government, Law & Civil Services",
        "Arts, Design & Media",
        "Education & Social Sciences",
        "Still undecided"
        ]
    },
    {
        id: 10,
        question: "What is your biggest challenge right now in career planning?",
        subtext: "Select one.",
        type: "single",
        options: [
        "Too many options, I feel confused",
        "Lack of proper guidance / mentorship",
        "Uncertainty about exams and admissions",
        "Financial constraints",
        "Balancing board exams with entrance prep",
        "Not sure where to start"
        ]
    }
    ];


    // --- state / DOM refs ---
    let currentQuestionIndex = 0;
    const userAnswers = {};
    const urlParams = new URLSearchParams(window.location.search);
    const phase = urlParams.get("phase");

    // --- Prefill & skip first question based on study-level (URL param OR saved localStorage value) ---
    const levelParam = urlParams.get('level') || localStorage.getItem('careerDishaStudentLevel');
    // mapping must match the exact option strings in quizData[0].options
    const levelToOption = {
      'class10': 'Class 10',
      '11-12': 'Class 12',
      'college': 'College (UG)'
    };
    
    let skipFirstQuestion = false; // if true we will not show Q1 in UI (but still save its answer)
    if (levelParam && quizData && quizData.length > 0) {
      const mapped = levelToOption[levelParam];
      if (mapped) {
        // Pre-answer Q1 so API gets the value
        userAnswers[quizData[0].id] = [mapped];
    
        // Skip the first question UI so user doesn't see it again
        skipFirstQuestion = true;
    
        // Start the quiz at the second question (index 1)
        currentQuestionIndex = 1;
      }
    }
    


    const quizContainer = document.getElementById('quiz-container');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');

    // --- rendering ---
   function renderQuestion() {
    const questionData = quizData[currentQuestionIndex];

    // ✅ New: handle text-answer questions (no options)
    if (!questionData.options || questionData.options.length === 0) {
        quizContainer.innerHTML = `
            <h2 class="text-2xl font-bold text-gray-900 mb-2">${questionData.question}</h2>
            <p class="text-gray-600 mb-8">${questionData.subtext || ""}</p>
            <input 
              type="text" 
              id="free-answer" 
              placeholder="Enter your answer here..." 
              class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
        `;
        return; // stop here, no options to render
    }

    // existing rendering for options
    let optionsHtml = '';
    questionData.options.forEach(option => {
        const isSelected = userAnswers[questionData.id] && userAnswers[questionData.id].includes(option);
        optionsHtml += `
            <div class="quiz-card border-2 border-gray-200 rounded-lg p-4 cursor-pointer ${isSelected ? 'selected' : ''}" data-value="${option}">
                <h3 class="font-medium text-gray-800">${option}</h3>
            </div>
        `;
    });

    quizContainer.innerHTML = `
        <h2 class="text-2xl font-bold text-gray-900 mb-2">${questionData.question}</h2>
        <p class="text-gray-600 mb-8">${questionData.subtext}</p>
        <div class="grid grid-cols-1 ${questionData.options.length > 4 ? 'sm:grid-cols-2' : ''} gap-4">
            ${optionsHtml}
        </div>
    `;
        document.querySelectorAll('.quiz-card').forEach(card => {
            card.addEventListener('click', () => handleOptionSelect(card, questionData));
        });

        updateNavigation();
        feather.replace();
    }

    function handleOptionSelect(card, questionData) {
        const value = card.dataset.value;
        if (!userAnswers[questionData.id]) {
            userAnswers[questionData.id] = [];
        }

        if (questionData.type === 'single') {
            userAnswers[questionData.id] = [value];
            document.querySelectorAll('.quiz-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
        } else if (questionData.type === 'multiple') {
            const selectedValues = userAnswers[questionData.id];
            if (selectedValues.includes(value)) {
                userAnswers[questionData.id] = selectedValues.filter(v => v !== value);
                card.classList.remove('selected');
            } else {
                if (!questionData.maxSelections || selectedValues.length < questionData.maxSelections) {
                    userAnswers[questionData.id].push(value);
                    card.classList.add('selected');
                }
            }
        }
    }

    function updateNavigation() {
        // If we skipped Q1, show counts relative to the visible questions
        const displayTotal = skipFirstQuestion ? (quizData.length - 1) : quizData.length;
        // If skipping Q1 we start at index 1, but for user-visible numbering we want "1" when currentQuestionIndex === 1
        const displayCurrent = skipFirstQuestion ? (currentQuestionIndex - 0) : (currentQuestionIndex + 1);
    
        document.getElementById('current-question-display').textContent = displayCurrent;
        document.getElementById('total-questions-display').textContent = displayTotal;
        document.getElementById('quiz-progress').style.width = ((displayCurrent) / displayTotal) * 100 + '%';
    
        // hide Prev if we're at the start (if Q1 skipped, start index is 1)
        prevBtn.classList.toggle('hidden', currentQuestionIndex === (skipFirstQuestion ? 1 : 0));
    
        nextBtn.innerHTML = currentQuestionIndex === quizData.length - 1
            ? 'Finish & See Results <i data-feather="award" class="inline-block ml-2 h-4 w-4"></i>'
            : 'Next <i data-feather="arrow-right" class="inline-block ml-2 h-4 w-4"></i>';
    }
    

    nextBtn.addEventListener('click', () => {
    const questionData = quizData[currentQuestionIndex];

    // ✅ Handle free-text questions
    if (!questionData.options || questionData.options.length === 0) {
        const input = document.getElementById('free-answer');
        const value = input.value.trim();
        if (!value) {
            alert("Please enter an answer before continuing.");
            return;
        }
        userAnswers[questionData.id] = [value];
    }
    // ✅ Handle option-based questions
    else if (!userAnswers[questionData.id] || userAnswers[questionData.id].length === 0) {
        alert("Please select an option to continue.");
        return;
    }

    if (currentQuestionIndex < quizData.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    } else {
        finishQuiz();
    }
});


    prevBtn.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            renderQuestion();
        }
    });

    // --- main finishQuiz with both Phase 1 & Phase 2 logic ---
    async function finishQuiz() {
    // Hide quiz UI, show loading spinner
    quizContainer.classList.add('hidden');
    document.getElementById('navigation-buttons').classList.add('hidden');
    document.getElementById('loading-container').classList.remove('hidden');

    try {
        const GEMINI_API_KEY = "AIzaSyBvR0vZe9wRr7ul6diO45SaueK8-D_Amk4";
        const SUPABASE_URL = "https://mnarcdqecoxdidnjakch.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1uYXJjZHFlY294ZGlkbmpha2NoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MTg2NzgsImV4cCI6MjA3MzA5NDY3OH0.INsDlgDxsrQiWPdZfRIXcI3EWLqD7dvWkaq3klaQyuc";

        if (phase !== "final") {
            // ================= Phase 1: Generate Follow-up Questions =================
           const prompt = `
You are an expert career counselor. 
Your task is to generate EXACTLY 10 follow-up questions for a Class 11/12 student.

⚠️ Rules:
- All 10 must be **multiple-choice** (no text-only questions).
- Each must have **3–5 options**.
- Each must be marked with "type": "single" or "multiple".
- Do not include any free-text or open-ended questions.

Return ONLY valid JSON in this format:
{
  "extraQuestions": [
    { "id": 101, "question": "Sample Q?", "type": "single", "options": ["A","B","C"] }
  ]
}

Student's answers so far:
${JSON.stringify(userAnswers, null, 2)}
`;


            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7, maxOutputTokens: 800, response_mime_type: "application/json" }
                })
            });

            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            let parsedPhase1;
            try {
                const jsonString = generatedText.substring(generatedText.indexOf('{'), generatedText.lastIndexOf('}') + 1);
                parsedPhase1 = JSON.parse(jsonString);
            } catch (e) {
                console.error("Failed to parse Gemini output as JSON (phase1):", e, generatedText);
                alert("The AI response was not in the correct format. Please try again.");
                document.getElementById('loading-container').classList.add('hidden');
                return;
            }
            
            // ✅ Ensure we ONLY keep MCQs with options
let extraQs = parsedPhase1.extraQuestions || [];

// ✅ Step 1: filter out any invalid/text-only questions
extraQs = extraQs.filter(q => Array.isArray(q.options) && q.options.length > 0);

// ✅ Step 2: pad until exactly 10
while (extraQs.length < 10) {
  extraQs.push({
    id: 200 + extraQs.length,
    question: `Backup Question ${extraQs.length + 1}`,
    type: "single",
    options: ["Option A", "Option B", "Option C", "Option D"]
  });
}

// ✅ Step 3: trim if more than 10
extraQs = extraQs.slice(0, 10);


// Trim if Gemini gave more than 10
extraQs = extraQs.slice(0, 10);


            localStorage.setItem("careerDishaExtraQuestions", JSON.stringify(extraQs));
            localStorage.setItem("careerDishaQuizAnswers", JSON.stringify(userAnswers));
            
            window.location.href = "./questions.html?from=quiz12";

        } else {
            // ================= Phase 2: Final Analysis =================
            
            // --- THIS WAS THE MISSING PART ---
            // These lines define the combinedAnswers variable before it's used.
            const quizAnswers = JSON.parse(localStorage.getItem("careerDishaQuizAnswers") || "{}");
            const extraAnswers = JSON.parse(localStorage.getItem("careerDishaExtraAnswers") || "{}");
            const combinedAnswers = { quizAnswers, extraAnswers };
            // --- END OF FIX ---

            const prompt = `
    You are an expert career counselor for students in Jammu & Kashmir, India, who are in Class 11 or 12. The current date is September 17, 2025.
    Based on the student's answers, generate a personalized roadmap.

    ***
    **Student's Answers:**
    ${JSON.stringify(combinedAnswers, null, 2)}
    ***

    Your task is to return ONLY a JSON object with five keys: "roadmapSummary", "topCareerPaths", "careerWeb", "keyTimeline", and "recommendedResources".

    1.  **roadmapSummary**: A personalized summary (~150 words) focusing on advice for Class 11/12.
    2.  **topCareerPaths**: An array of 4 career path objects, each with "career", "description", "salary", and an "icon".
    3.  **careerWeb**: An object representing 2-3 different branching career paths.
    4.  **keyTimeline**: An array of 3-4 upcoming events. Each event must be an object with "title", "date", and "type" ('exam' or 'event').
    5.  **recommendedResources**: An array of 2-4 helpful resources. Each resource must be an object with "title", "description", and a real, valid "url".

    Example of the required JSON output format:
    {
      "roadmapSummary": "...", "topCareerPaths": [], "careerWeb": {},
      "keyTimeline": [ { "title": "JEE Main 2026 Registration", "date": "Nov 2025", "type": "exam" } ],
      "recommendedResources": [ { "title": "NTA Official Website", "description": "Official source for JEE, NEET, CUET dates.", "url": "https://nta.ac.in/" } ]
    }
`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.7, maxOutputTokens: 2048, response_mime_type: "application/json" }
                })
            });

            if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
            const result = await response.json();
            const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            let parsedPhase2;
            try {
                const jsonString = generatedText.substring(generatedText.indexOf('{'), generatedText.lastIndexOf('}') + 1);
                parsedPhase2 = JSON.parse(jsonString);
            } catch (e) {
                console.error("Failed to parse Gemini output (phase2):", e, generatedText);
                parsedPhase2 = { roadmapSummary: "Error generating roadmap.", topCareerPaths: [], careerWeb: {}, keyTimeline: [] };
            }

            const finalResults = {
    roadmapSummary: parsedPhase2.roadmapSummary,
    topCareerPaths: parsedPhase2.topCareerPaths || [],
    careerWeb: parsedPhase2.careerWeb,
    keyTimeline: parsedPhase2.keyTimeline || [],
    recommendedResources: parsedPhase2.recommendedResources || [] // Make sure this line is present
};;

            localStorage.setItem("careerDishaResults", JSON.stringify(finalResults));

            await fetch(`${SUPABASE_URL}/rest/v1/quiz_results`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "apikey": SUPABASE_ANON_KEY, "Authorization": `Bearer ${SUPABASE_ANON_KEY}` },
                body: JSON.stringify({ phase: "final", answers: combinedAnswers, results: finalResults })
            });

            window.location.href = "./dashboard12.html";
        }
    } catch (err) {
        console.error("Error during analysis:", err);
        alert("An error occurred during the analysis. Please check your internet connection and try again.");
        // Hide loading spinner and show quiz UI again on error
        document.getElementById('loading-container').classList.add('hidden');
        document.getElementById('progress-container').classList.remove('hidden');
        quizContainer.classList.remove('hidden');
        document.getElementById('navigation-buttons').classList.remove('hidden');
    }
}

    // Initial load - render quiz or run final phase
    if (phase !== "final") {
        renderQuestion();
    } else {
    // FIX: Hide progress bar on final analysis page
    document.getElementById('progress-container').classList.add('hidden');
    quizContainer.classList.add('hidden');
    document.getElementById('navigation-buttons').classList.add('hidden');
    document.getElementById('loading-container').classList.remove('hidden');
    finishQuiz();
}
    </script>
</body>
</html>
